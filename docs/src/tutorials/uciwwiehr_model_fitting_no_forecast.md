```@setup tutorial
using Plots, StatsPlots; gr()
Plots.reset_defaults()

```

# [Generating Posterior Distribution Samples with UCIWWEIHR ODE Compartmental Based Model without Forecasting.](@id uciwwiehr_model_fitting_no_forecast)

This package has a way to sample from a posterior or prior that is defined in the future paper using the `uciwweihr_fit.jl` and `uciwweihr_model.jl`.  We can then generate desired quantities and forecast for a given time period with the posterior predictive distribution, using `uciwweihr_gq_pp.jl`.  We first generate data using the `generate_simulation_data_uciwweihr` function which is a non-mispecified version of the model, we will also be using prespecified effective reporduction curves and prespecified hospitalization probability curves.


## 1. Data Generation.

``` @example tutorial
using UCIWWEIHR
# Running simulation function with presets
rt_custom = vcat(
    range(1, stop=1.8, length=7*2),
    fill(1.8, 7*1),
    range(1.8, stop=1, length=7*4),
    range(0.98, stop=0.8, length=7*1),
    range(0.8, stop=1.1, length=7*3),
    range(1.1, stop=0.97, length=7*1)
)
w_custom = vcat(
    range(0.3, stop=0.38, length=7*2),
    fill(0.38, 7*1),
    range(0.38, stop=0.25, length=7*4),
    range(0.25, stop=0.28, length=7*1),
    range(0.28, stop=0.34, length=7*3),
    range(0.34, stop=0.28, length=7*1)
)
params = create_uciwweihr_sim_params(
    time_points = length(rt_custom),
    Rt = rt_custom, 
    w = w_custom
)
df = generate_simulation_data_uciwweihr(params)
first(df, 5)
```

## 2. Sampling from the Posterior Distribution and Posterior Predictive Distribution.

Here we sample from the posterior distribution using the `uciwweihr_fit.jl` function.  First, we setup some presets, where we need to use `create_uciwweihr_model_params()` to get default parameters for the model.  Then we have an array where index 1 contains the posterior/prior predictive samples, index 2 contains the posterior/prior generated quantities samples, and index 3 contains the original sampled parameters for the model.  Again, we can allow misalignment of hospital and wastewater data's observed times.  For this tutorial, we use the same observed points.

``` @example tutorial
data_hosp = df.hosp
data_wastewater = df.log_ww_conc
obstimes_hosp = df.obstimes
obstimes_wastewater = df.obstimes
max_obstime = max(length(obstimes_hosp), length(obstimes_wastewater))
param_change_times = 1:7:max_obstime # Change every week
priors_only = false
n_samples = 500
forecast = false
forecast_days = 0

model_params = create_uciwweihr_model_params2()
samples = uciwweihr_fit(
    data_hosp,
    data_wastewater,
    obstimes_hosp,
    obstimes_wastewater,
    param_change_times,
    model_params;
    priors_only,
    n_samples,
    n_discard_initial = 200
    )
model_output = uciwweihr_gq_pp(
    samples,
    data_hosp,
    data_wastewater,
    obstimes_hosp,
    obstimes_wastewater,
    param_change_times,
    model_params;
    forecast=forecast, forecast_days=forecast_days
)

first(model_output[1][:,1:5], 5)
```

``` @example tutorial
first(model_output[2][:,1:5], 5)
```

``` @example tutorial
first(model_output[3][:,1:5], 5)
```

## 3. MCMC Diagnostic Plots/Results Along with Posterior Predictive Distribution.

We also provide a very basic way to visualize some MCMC diagnostics along with effective sample sizes of desired generated quantities(does not include functionality for time-varying quantities).  Along with this, we can also visualize the posterior predictive distribution with actual observed values, which can be used to examine forecasts generated by the model.  We can also add certain parameters to ensure priors will be plotted alongside their corresponding posteriors.

```@example tutorial
uciwweihr_visualizer(
    data_hosp, 
    data_wastewater,
    forecast_days,
    obstimes_hosp,
    obstimes_wastewater,
    param_change_times,
    2024,
    forecast,
    model_params;
    pp_samples = model_output[1],
    gq_samples = model_output[2],
    samples = model_output[3],
    obs_data_hosp = data_hosp,
    obs_data_wastewater = data_wastewater, 
    actual_rt_vals = df.rt, 
    actual_w_t = df.wt, 
    actual_E_ode_sol = df.E_ode_comp_sol,
    actual_I_ode_sol = df.I_ode_comp_sol,
    actual_H_ode_sol = df.H_ode_comp_sol,
    actual_non_time_varying_vals = params,
    bayes_dist_type = "Posterior",
    save_plots = true,
    plot_name_to_save_mcmcdiag = "plots/mcmc_diagnosis_plots",
    plot_name_to_save_time_varying = "plots/mcmc_time_varying_parameter_plots",
    plot_name_to_save_non_time_varying = "plots/mcmc_nontime_varying_parameter_plots",
    plot_name_to_save_ode_sol = "plots/mcmc_ode_solution_plots",
    plot_name_to_save_pred_param = "plots/mcmc_pred_parameter_plots",
    plot_name_to_save_log_prob_trace = "plots/mcmc_log_prob_trace_plot"
)
```

### 3.1. MCMC Diagnostic Plots.

![Plot 1](plots/mcmc_diagnosis_plots.png)

### 3.2. Time Varying Parameter Results Plot.

![Plot 2](plots/mcmc_time_varying_parameter_plots.png)

### 3.3. Non-Time Varying Parameter Results Plot.
![Plot 3](plots/mcmc_nontime_varying_parameter_plots.png)

### 3.4. ODE Solution Plot.
![Plot 4](plots/mcmc_ode_solution_plots.png)

### 3.4. Posterior Predictive Distribution Plot.

![Plot 4](plots/mcmc_pred_parameter_plots.png)

### 3.5. Log Prob Trace Plot.
![Plot 5](plots/mcmc_log_prob_trace_plot.png)


### [Tutorial Contents](@ref tutorial_home)